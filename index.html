<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YTPro - Video Indirici</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#FF0000',
                            dark: '#0F0F0F',
                            gray: '#272727',
                            light: '#F1F1F1'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0F0F0F;
            color: white;
        }

        .glass-panel {
            background: rgba(39, 39, 39, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">

    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div
            class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-brand-red rounded-full mix-blend-screen filter blur-[100px] opacity-20 animate-pulse">
        </div>
        <div
            class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-600 rounded-full mix-blend-screen filter blur-[100px] opacity-20 animate-pulse">
        </div>
    </div>

    <main class="w-full max-w-3xl z-10">
        <div class="text-center mb-10">
            <div class="flex items-center justify-center gap-3 mb-4">
                <i class="fa-brands fa-youtube text-5xl text-brand-red"></i>
                <h1 class="text-4xl font-bold tracking-tight">YT<span class="text-brand-red">Pro</span> Indirici</h1>
            </div>
            <p class="text-gray-400 text-lg">YouTube videolarini yuksek kalitede MP4 veya MP3'e donusturun.</p>
        </div>

        <div class="glass-panel rounded-2xl p-2 mb-8 shadow-2xl">
            <div class="flex flex-col md:flex-row gap-2">
                <div class="relative flex-grow">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                        <i class="fa-solid fa-link text-gray-500"></i>
                    </div>
                    <input type="text" id="urlInput"
                        class="w-full bg-transparent text-white border-none focus:ring-0 pl-10 pr-4 py-4 placeholder-gray-500 text-lg outline-none"
                        placeholder="YouTube video baglantisinini buraya yapistirin...">
                    <button id="pasteBtn"
                        class="absolute right-2 top-1/2 transform -translate-y-1/2 text-xs bg-brand-gray hover:bg-gray-600 text-gray-300 px-2 py-1 rounded transition hidden md:block">
                        Yapistir
                    </button>
                </div>
                <button onclick="fetchVideoInfo()" id="searchBtn"
                    class="bg-brand-red hover:bg-red-700 text-white font-bold py-3 px-8 rounded-xl transition-all duration-300 flex items-center justify-center gap-2 shadow-lg shadow-red-900/30">
                    <span>Basla</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div id="loadingIndicator" class="hidden flex-col items-center justify-center py-8">
            <div class="w-8 h-8 border-3 border-t-brand-red border-gray-300 rounded-full animate-spin mb-3"></div>
            <p class="text-gray-400 text-sm animate-pulse">Video bilgileri getiriliyor...</p>
        </div>

        <div id="resultArea" class="hidden">
            <div class="glass-panel rounded-2xl overflow-hidden shadow-2xl border border-gray-700">
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-2/5 relative group">
                        <img id="videoThumb" src="" alt="Video Thumbnail"
                            class="w-full h-full object-cover aspect-video">
                    </div>
                    <div class="md:w-3/5 p-6 flex flex-col justify-between">
                        <div>
                            <h2 id="videoTitle" class="text-xl font-bold mb-2 line-clamp-2 leading-snug">Video Basligi
                            </h2>
                            <p class="text-gray-400 text-sm mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-user-circle"></i> <span id="authorName">Kanal Adi</span>
                            </p>
                        </div>
                        <div class="space-y-3">
                            <div
                                class="flex items-center justify-between text-xs text-gray-400 uppercase tracking-wider font-semibold mb-1">
                                <span>Format</span>
                                <span>Boyut (Tahmini)</span>
                            </div>
                            <div class="group flex items-center justify-between p-3 rounded-lg bg-[#1a1a1a] hover:bg-[#333] border border-transparent hover:border-gray-600 transition-all cursor-pointer"
                                onclick="downloadVideo('1080p', 'mp4')">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded bg-red-900/30 text-red-500 flex items-center justify-center">
                                        <i class="fa-solid fa-video"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-white">MP4 Video</div>
                                        <div class="text-xs text-green-400">1080p Full HD</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-gray-400">~145 MB</span>
                                    <button
                                        class="w-8 h-8 rounded-full bg-brand-gray group-hover:bg-brand-red flex items-center justify-center transition-colors">
                                        <i class="fa-solid fa-download text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="group flex items-center justify-between p-3 rounded-lg bg-[#1a1a1a] hover:bg-[#333] border border-transparent hover:border-gray-600 transition-all cursor-pointer"
                                onclick="downloadVideo('720p', 'mp4')">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded bg-blue-900/30 text-blue-500 flex items-center justify-center">
                                        <i class="fa-solid fa-video"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-white">MP4 Video</div>
                                        <div class="text-xs text-blue-400">720p HD</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-gray-400">~85 MB</span>
                                    <button
                                        class="w-8 h-8 rounded-full bg-brand-gray group-hover:bg-blue-600 flex items-center justify-center transition-colors">
                                        <i class="fa-solid fa-download text-sm"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="group flex items-center justify-between p-3 rounded-lg bg-[#1a1a1a] hover:bg-[#333] border border-transparent hover:border-gray-600 transition-all cursor-pointer"
                                onclick="downloadVideo('320kbps', 'mp3')">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-8 h-8 rounded bg-green-900/30 text-green-500 flex items-center justify-center">
                                        <i class="fa-solid fa-music"></i>
                                    </div>
                                    <div>
                                        <div class="font-semibold text-white">MP3 Ses</div>
                                        <div class="text-xs text-green-400">320kbps Yuksek Kalite</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-sm text-gray-400">~5 MB</span>
                                    <button
                                        class="w-8 h-8 rounded-full bg-brand-gray group-hover:bg-green-600 flex items-center justify-center transition-colors">
                                        <i class="fa-solid fa-download text-sm"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="downloadModal"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
            <div class="bg-[#1f1f1f] border border-gray-700 p-8 rounded-2xl max-w-sm w-full text-center relative transform scale-90 transition-transform duration-300"
                id="modalContent">
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
                <div id="modalStep1">
                    <div
                        class="w-16 h-16 border-4 border-brand-red border-t-transparent rounded-full animate-spin mx-auto mb-4">
                    </div>
                    <h3 class="text-xl font-bold mb-2">Indiriliyor...</h3>
                    <p class="text-gray-400 text-sm mb-4">Lutfen bekleyin, dosyaniz hazirlaniyor.</p>
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-2">
                        <div id="progressBar" class="bg-brand-red h-2 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progressText" class="text-xs text-right text-gray-500">0%</p>
                </div>
                <div id="modalStep2" class="hidden">
                    <div
                        class="w-16 h-16 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fa-solid fa-check text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Indirme Tamamlandi!</h3>
                    <p class="text-gray-400 text-sm mb-6">Dosyaniz basariyla indirildi.</p>
                    <button onclick="closeModal()"
                        class="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200 transition">
                        Tamam
                    </button>
                </div>
            </div>
        </div>
    </main>

    <footer class="absolute bottom-4 text-center w-full text-gray-600 text-xs">
        <p>2024 YTPro Video Indirici. Tum haklari saklidir.</p>
    </footer>

    <script>
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:5000' : window.location.origin;

        const urlInput = document.getElementById('urlInput');
        const searchBtn = document.getElementById('searchBtn');
        const pasteBtn = document.getElementById('pasteBtn');
        const resultArea = document.getElementById('resultArea');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const videoThumb = document.getElementById('videoThumb');
        const videoTitle = document.getElementById('videoTitle');
        const authorName = document.getElementById('authorName');

        let currentVideoUrl = '';
        let currentVideoTitle = '';

        pasteBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                urlInput.value = text;
            } catch (err) {
                alert('Pano erisimi reddedildi.');
            }
        });

        urlInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') fetchVideoInfo();
        });

        async function fetchVideoInfo() {
            const url = urlInput.value.trim();
            const youtubeRegex = /^(https?\:\/\/)?(www\.youtube\.com|youtu\.?be)\/.+$/;

            if (!url) {
                alert("Lutfen bir URL girin.");
                return;
            }

            if (!youtubeRegex.test(url)) {
                alert("Lutfen gecerli bir YouTube baglantisi girin.");
                return;
            }

            currentVideoUrl = url;
            resultArea.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.classList.add('flex');
            searchBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/api/info?url=${encodeURIComponent(url)}`);
                const data = await response.json();

                if (!response.ok || data.error) {
                    throw new Error(data.error || "Video bulunamadi");
                }

                videoTitle.textContent = data.title;
                currentVideoTitle = data.title;
                authorName.textContent = data.author;
                videoThumb.src = data.thumbnail;

                loadingIndicator.classList.remove('flex');
                loadingIndicator.classList.add('hidden');
                resultArea.classList.remove('hidden');
                searchBtn.disabled = false;

            } catch (error) {
                loadingIndicator.classList.remove('flex');
                loadingIndicator.classList.add('hidden');
                searchBtn.disabled = false;

                if (error.message.includes('Failed to fetch')) {
                    alert("Backend sunucusu calismiyor!\n\npython server.py");
                } else {
                    alert("Hata: " + error.message);
                }
            }
        }

        async function downloadVideo(quality, format) {
            const modal = document.getElementById('downloadModal');
            const modalContent = document.getElementById('modalContent');
            const step1 = document.getElementById('modalStep1');
            const step2 = document.getElementById('modalStep2');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');

            let formatId;
            switch (quality) {
                case '1080p':
                    formatId = 'bestvideo[height<=1080]+bestaudio/best[height<=1080]';
                    break;
                case '720p':
                    formatId = 'bestvideo[height<=720]+bestaudio/best[height<=720]';
                    break;
                case '320kbps':
                    formatId = 'bestaudio/best';
                    break;
                default:
                    formatId = 'best';
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-90');
                modalContent.classList.add('scale-100');
            }, 10);

            step1.classList.remove('hidden');
            step2.classList.add('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = 'Hazirlaniyor...';

            try {
                let progress = 0;
                const progressInterval = setInterval(() => {
                    if (progress < 90) {
                        progress += Math.floor(Math.random() * 3) + 1;
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${progress}% - Indiriliyor...`;
                    }
                }, 200);

                const downloadUrl = `${API_BASE}/api/download?url=${encodeURIComponent(currentVideoUrl)}&format_id=${encodeURIComponent(formatId)}&type=${format}`;
                const response = await fetch(downloadUrl);

                clearInterval(progressInterval);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Indirme basarisiz');
                }

                const blob = await response.blob();
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(blob);

                // Dosya adini al - X-Filename header veya Content-Disposition
                let filename = `${currentVideoTitle}.${format}`;

                const xFilename = response.headers.get('X-Filename');
                if (xFilename) {
                    filename = decodeURIComponent(xFilename);
                } else {
                    const contentDisposition = response.headers.get('Content-Disposition');
                    if (contentDisposition) {
                        const utf8Match = contentDisposition.match(/filename\*=UTF-8''([^;\s]+)/i);
                        if (utf8Match && utf8Match[1]) {
                            filename = decodeURIComponent(utf8Match[1]);
                        }
                    }
                }

                downloadLink.download = filename;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(downloadLink.href);

                progressBar.style.width = '100%';
                progressText.textContent = '100%';

                setTimeout(() => {
                    step1.classList.add('hidden');
                    step2.classList.remove('hidden');
                }, 300);

            } catch (error) {
                closeModal();
                alert("Indirme hatasi: " + error.message);
            }
        }

        function closeModal() {
            const modal = document.getElementById('downloadModal');
            const modalContent = document.getElementById('modalContent');
            modal.classList.add('opacity-0');
            modalContent.classList.remove('scale-100');
            modalContent.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
    </script>
</body>

</html>

